<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de DESA (Adulto y Pediátrico)</title>
    <!-- Carga de Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fuente Inter */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Estilos para el torso del paciente - ELIMINADOS */
        /* .torso, .cuello, .hombro, .marcador-parche, .parche-dea, etc... han sido eliminados */


        /* Animación de parpadeo para el botón de descarga */
        @keyframes flash {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
                box-shadow: 0 0 10px #f59e0b, 0 0 20px #f59e0b;
            }
            50% { 
                opacity: 0.8; 
                transform: scale(1.05);
                box-shadow: 0 0 20px #f59e0b, 0 0 40px #f59e0b;
            }
        }
        .flashing {
            animation: flash 1s infinite;
        }

        /* Animación de pulso para el metrónomo */
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1); 
                opacity: 0.7;
            }
            50% { 
                transform: scale(1.1); 
                opacity: 1;
            }
        }
        .pulsing {
            animation: pulse 0.6s infinite; /* 100 bpm */
        }

        /* Estilos específicos para el panel del DESA */
        .desa-panel {
            background-color: #e0e0e0; /* Color base del dispositivo */
            border-radius: 12px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1), 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .desa-screen {
            background-color: #4CAF50; /* Pantalla verde, como en el iPAD */
            border: 3px solid #388E3C;
            border-radius: 8px;
            padding: 10px;
            min-height: 80px;
            width: 90%;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: bold;
            color: white;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.3);
            font-size: 1.1rem;
        }
        
        .instruction-image-container {
            position: relative;
            width: 200px;
            height: 250px;
            background-color: #d8d8d8;
            border: 1px solid #a0a0a0;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Asegura que el contenido no se desborde */
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
        }

        /* --- Estilos para diagramas Pediátrico (Pecho/Espalda) --- */
        .instruction-image-torso_sm {
            width: 80px; 
            height: 120px; 
            background-color: #f0c9a8;
            border: 1px solid #b3977c; 
            border-radius: 15px 15px 0 0; 
            position: relative;
        }
        .instruction-image-head_sm {
            width: 30px; 
            height: 30px; 
            background-color: inherit;
            border: 1px solid #b3977c; 
            border-radius: 50%;
            position: absolute; 
            top: -25px; 
            left: 50%; 
            transform: translateX(-50%);
        }
        .instruction-image-patch_sm {
            position: absolute; 
            width: 35px; 
            height: 50px;
            background-color: #a0a0a0; 
            border: 1px solid #666; 
            border-radius: 4px;
        }
        
        /* --- Estilos para diagrama Adulto --- */
        .instruction-image-torso_lg {
            width: 120px;
            height: 180px;
            background-color: #f0c9a8; /* Tono de piel */
            border: 1px solid #b3977c;
            border-radius: 20px 20px 0 0;
            position: relative;
        }
        .instruction-image-head_lg {
            width: 40px;
            height: 40px;
            background-color: #f0c9a8;
            border: 1px solid #b3977c;
            border-radius: 50%;
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
        }
        .instruction-image-patch_lg {
            position: absolute;
            width: 40px;
            height: 55px;
            background-color: #a0a0a0;
            border: 1px solid #666;
            border-radius: 4px;
        }
        
        /* --- FIN Estilos de Diagramas --- */

        .desa-button-group {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 20px;
        }

        .desa-button {
            border-radius: 9999px; /* Botones redondos */
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: all 0.2s ease-in-out;
            transform: scale(1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: relative;
        }
        .desa-button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .desa-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: scale(1);
            box-shadow: none;
        }

        #btn-power {
            background-color: #4CAF50; /* Verde */
            color: white;
            width: 70px;
            height: 70px;
            font-size: 0.9rem;
            border: 2px solid #388E3C;
        }
        #btn-power.opacity-50 {
            background-color: #66BB6A; /* Verde más claro cuando está encendido */
            border-color: #4CAF50;
        }
        #btn-power span {
            display: block;
            line-height: 1;
        }

        #btn-shock {
            background-color: #FFC107; /* Naranja */
            color: #333;
            width: 70px;
            height: 70px;
            font-size: 0.9rem;
            border: 2px solid #FFA000;
        }
        #btn-shock.flashing {
            color: white; /* Texto blanco cuando parpadea */
            border-color: #FB8C00;
        }

        /* Indicador de estado (LED) */
        .status-light {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: #999; /* Gris por defecto */
            border: 1px solid #666;
            margin-right: 10px;
        }
        .status-light.active {
            background-color: #4CAF50; /* Verde cuando está activo */
            box-shadow: 0 0 8px #4CAF50, 0 0 12px #4CAF50;
        }
    </style>
</head>
<body class="bg-gray-200 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-6xl mx-auto bg-white shadow-2xl rounded-lg p-6">

        <!-- PANTALLA DE SELECCIÓN DE MODO -->
        <div id="selection-screen" class="text-center">
            <h1 class="text-3xl font-bold text-blue-800 mb-8">Simulador de DESA</h1>
            <h2 class="text-2xl font-semibold text-gray-700 mb-6">Seleccione el protocolo del paciente:</h2>
            <div class="flex flex-col md:flex-row justify-center gap-6">
                <button id="btn-select-adult" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-6 px-12 rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105">
                    <span class="text-3xl">ADULTO</span>
                    <span class="block text-lg">(+ 8 años)</span>
                </button>
                <button id="btn-select-pediatric" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-6 px-12 rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105">
                    <span class="text-3xl">PEDIÁTRICO</span>
                    <span class="block text-lg">(1 - 8 años)</span>
                </button>
            </div>
        </div>

        <!-- SIMULADOR PRINCIPAL (Oculto al inicio) -->
        <div id="simulator-main" class="hidden">
            <h1 id="simulator-title" class="text-3xl font-bold text-center text-blue-800 mb-6">Simulador de DESA</h1>
            
            <!-- CORRECCIÓN: Contenedor modificado para centrar el panel del DESA -->
            <div class="flex justify-center">

                <!-- Columna del Paciente -- ELIMINADA -->
                <!--
                <div class="w-full md:w-1/2 bg-gray-100 p-6 rounded-lg shadow-inner flex flex-col items-center justify-center min-h-[400px]">
                    ... (HTML del paciente eliminado) ...
                </div>
                -->

                <!-- Columna del DESA (Panel de Control) -->
                <!-- CORRECCIÓN: Clases de ancho modificadas para centrar -->
                <div class="w-full md:w-3/4 lg:w-1/2 desa-panel">
                    <div class="absolute top-4 right-4 flex items-center">
                        <div id="status-light" class="status-light"></div>
                        <span class="text-gray-700 font-semibold text-sm">Estado</span>
                    </div>

                    <div class="desa-screen">
                        <p id="instruction-text" class="text-white">Dispositivo apagado. Presione el botón de encendido.</p>
                    </div>

                    <!-- Contenedor de Diagramas -->
                    <div class="instruction-image-container">
                        
                        <!-- Diagrama Adulto (Oculto) -->
                        <div id="diagrama-adulto" class="hidden text-center">
                            <div class="relative instruction-image-torso_lg">
                                <div class="instruction-image-head_lg"></div>
                                <div class="instruction-image-patch_lg" style="top: 30px; left: 15px; transform: rotate(-5deg);"></div>
                                <div class="instruction-image-patch_lg" style="bottom: 30px; right: 15px; transform: rotate(5deg);"></div>
                            </div>
                        </div>

                        <!-- Diagrama Pediátrico (Oculto) -->
                        <!-- CORRECCIÓN: Se cambió 'items-center' por 'items-start' para que el texto no se solape --><div id="diagrama-pediatrico" class="hidden flex justify-around items-start p-2 w-full">
                            <div class="text-center">
                                <p class="font-bold text-gray-700 mb-1">PECHO</p>
                                <!-- CORRECCIÓN: Se añade 'mt-8' para bajar el muñeco -->
                                <div class="relative instruction-image-torso_sm mt-8">
                                    <div class="instruction-image-head_sm"></div>
                                    <div class="instruction-image-patch_sm" style="top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>
                                </div>
                            </div>
                            <div class="text-center">
                                <p class="font-bold text-gray-700 mb-1">ESPALDA</p>
                                <!-- CORRECCIÓN: Se añade 'mt-8' para bajar el muñeco -->
                                <div class="relative instruction-image-torso_sm mt-8" style="background-color: #e6bfa0;">
                                    <div class="instruction-image-head_sm"></div>
                                    <div class="instruction-image-patch_sm" style="top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Área de RCP (oculta al inicio) --><div id="cpr-area" class="text-center mb-6 hidden">
                        <div id="metronome" class="w-24 h-24 bg-red-500 rounded-full mx-auto mb-3 flex items-center justify-center font-bold text-4xl text-white shadow-lg">
                            <!-- Conteo -->
                        </div>
                        <div class="text-3xl font-mono text-gray-800" id="cpr-timer">2:00</div>
                        <p id="cpr-phase-text" class="text-xl text-gray-700 font-semibold">Inicie Compresiones</p>
                    </div>

                    <!-- Botones de Control --><div class="flex flex-col items-center gap-4 w-full">
                        <button id="btn-power" class="desa-button">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2a10 10 0 1010 10A10 10 0 0012 2zm0 18a8 8 0 118-8 8 8 0 01-8 8zM11 7v6a1 1 0 002 0V7a1 1 0 00-2 0z"/>
                            </svg>
                            <span class="ml-1">ON/<br>OFF</span>
                        </button>

                        <button id="btn-apply-pads" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105 w-auto" disabled>
                            Aplicar Parches
                        </button>
                        
                        <button id="btn-shock" class="desa-button">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                            DESCARGA
                        </button>

                        <button id="btn-reset" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md mt-4 w-auto">
                            CAMBIAR MODO
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Referencias a Elementos ---
        const instructionText = document.getElementById('instruction-text');
        const btnPower = document.getElementById('btn-power');
        const btnApplyPads = document.getElementById('btn-apply-pads');
        const btnShock = document.getElementById('btn-shock');
        const btnReset = document.getElementById('btn-reset');
        const statusLight = document.getElementById('status-light');

        // Pantallas
        const selectionScreen = document.getElementById('selection-screen');
        const simulatorMain = document.getElementById('simulator-main');
        const simulatorTitle = document.getElementById('simulator-title');

        // Botones de Selección
        const btnSelectAdult = document.getElementById('btn-select-adult');
        const btnSelectPediatric = document.getElementById('btn-select-pediatric');

        // Elementos Paciente (Marcadores) - ELIMINADOS
        // const marcadorAdulto1 = ...
        // const marcadorAdulto2 = ...
        // const marcadorPediatrico1 = ...

        // Elementos Paciente (Parches) - ELIMINADOS
        // const parcheAdulto1 = ...
        // const parcheAdulto2 = ...
        // const parchePediatrico1 = ...

        // Diagramas de Instrucción
        const diagramaAdulto = document.getElementById('diagrama-adulto');
        const diagramaPediatrico = document.getElementById('diagrama-pediatrico');

        // Área RCP
        const cprArea = document.getElementById('cpr-area');
        const metronome = document.getElementById('metronome');
        const cprTimerDisplay = document.getElementById('cpr-timer');
        const cprPhaseText = document.getElementById('cpr-phase-text');

        // --- Variables de Estado Global ---
        let protocolMode = null; // 'ADULT' o 'PEDIATRIC'
        let state = 'OFF'; // OFF, POWERED_ON, PADS_APPLIED, ANALYZING, SHOCK_ADVISED, SHOCK_READY, NO_SHOCK_ADVISED, CPR
        
        // Timers
        let cprOverallTimer, cprVisualTimer, cprCycleTimer;
        let cprPhase = 'COMPRESSIONS';
        let compressionCount = 1;
        let ventilationCount = 1;
        let cprSecondsLeft = 120;
        
        // Audio
        let audioCtx;
        let spanishVoice = null;
        const speech = window.speechSynthesis;

        // --- Funciones de Audio (NATIVAS - Web Audio API) ---
        // (Las funciones initAudioContext, playBeep, playChargingSound, updateVoiceList, speak no cambian)
        
        function initAudioContext() {
            try {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
            } catch (e) {
                console.error("Web Audio API no es soportada en este navegador.", e);
            }
        }
        
        function playBeep(frequency, duration, type = 'sine') {
            if (!audioCtx) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.type = type;
            oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime); 
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration - 0.05);
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + duration);
        }

        function playChargingSound(duration) {
            if (!audioCtx) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.type = 'sawtooth';
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + duration);
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + duration);
        }

        function updateVoiceList() {
            const voices = speech.getVoices();
            if (voices.length === 0) return;
            spanishVoice = voices.find(v => v.lang.startsWith('es-ES')) || 
                           voices.find(v => v.lang.startsWith('es-MX')) || 
                           voices.find(v => v.lang.startsWith('es-')) ||   
                           voices.find(v => v.lang.startsWith('es_')) ||   
                           null;
        }

        function speak(text) {
            if (speech.speaking) {
                speech.cancel();
            }
            if (!spanishVoice && speech.getVoices().length > 0) {
                updateVoiceList();
            }
            const utterance = new SpeechSynthesisUtterance(text);
            if (spanishVoice) {
                utterance.voice = spanishVoice;
                utterance.lang = spanishVoice.lang;
            } else {
                utterance.lang = 'es-ES';
                console.warn("No se encontró una voz en español. Usando fallback de idioma.");
            }
            utterance.pitch = 1;
            utterance.rate = 1.1;
            speech.speak(utterance);
        }

        // --- Funciones de Estado (Simulación) ---

        /**
         * Inicia el simulador con el modo seleccionado.
         * @param {string} mode 'ADULT' o 'PEDIATRIC'
         */
        function initSimulator(mode) {
            protocolMode = mode;
            
            // Ocultar selección y mostrar simulador
            selectionScreen.classList.add('hidden');
            simulatorMain.classList.remove('hidden');

            // Ajustar título
            simulatorTitle.textContent = (protocolMode === 'ADULT') ? 
                'Simulador de DESA - Adulto' : 
                'Simulador de DESA - Pediátrico (1-8 años)';
            
            // --- CORRECCIÓN: Lógica movida aquí ---
            // Mostrar los marcadores y diagrama correctos INMEDIATAMENTE
            // Lógica de marcadores eliminada
            if (protocolMode === 'ADULT') {
                diagramaAdulto.classList.remove('hidden');
            } else { // PEDIATRIC
                diagramaPediatrico.classList.remove('hidden');
            }
            // --- FIN DE CORRECCIÓN ---

            // Estado inicial de botones del simulador
            btnApplyPads.disabled = true;
            btnShock.disabled = true;
        }

        async function powerOn() {
            if (state !== 'OFF') return;

            try {
                initAudioContext();
                playBeep(523, 0.2, 'sine');
            } catch (e) {
                console.error("No se pudo iniciar el audio:", e);
            }

            state = 'POWERED_ON';
            statusLight.classList.add('active');
            
            updateInstruction('Dispositivo encendido. Mantenga la calma, siga las instrucciones.', 'info');
            speak('Dispositivo encendido. Mantenga la calma, siga las instrucciones.');

            btnPower.disabled = true;
            btnPower.classList.add('opacity-50', 'cursor-not-allowed');
            
            btnApplyPads.disabled = false;

            // --- LÓGICA DE MODO (MOVIDA a initSimulator) ---
            // (Esta sección se ha eliminado de aquí)

            // --- CORRECCIÓN: PROTOCOLO PEDIÁTRICO (5 VENTILACIONES) ---
            if (protocolMode === 'PEDIATRIC') {
                // 1. Nueva instrucción: 5 Ventilaciones
                setTimeout(() => {
                    const instruction = '¡Inicie con 5 ventilaciones de rescate!';
                    updateInstruction(instruction, 'warning');
                    speak(instruction);
                }, 3500); // 3.5 segundos después de encender

                // 2. Instrucción de parches (retrasada)
                setTimeout(() => {
                    const instruction = 'Ahora, quite la ropa y aplique los parches como se indica.';
                    updateInstruction(instruction, 'info');
                    speak(instruction);
                }, 8500); // 5 segundos después de la instrucción de ventilar (3500 + 5000)
            
            } else { // PROTOCOLO ADULTO (Directo a parches)
                setTimeout(() => {
                    const instruction = 'Quite toda la ropa del pecho del paciente. Aplique los parches como se indica.';
                    updateInstruction(instruction, 'info');
                    speak(instruction);
                }, 3500); 
            }
        }

        function applyPads() {
            if (state !== 'POWERED_ON') return;
            state = 'PADS_APPLIED';

            // --- LÓGICA DE MODO ---
            // Ocultar marcadores y mostrar parches correctos - SECCIÓN ELIMINADA
            /*
            if (protocolMode === 'ADULT') {
                ...
            } else { // PEDIATRIC
                ...
            }
            */

            btnApplyPads.disabled = true;
            btnApplyPads.classList.add('opacity-50', 'cursor-not-allowed');

            const instruction = 'Parches aplicados. No toque al paciente.';
            updateInstruction(instruction, 'warning');
            speak(instruction);

            setTimeout(startAnalysis, 3000);
        }

        function startAnalysis() {
            if (state !== 'PADS_APPLIED' && state !== 'CPR_DONE') return;
            state = 'ANALYZING';
            cprArea.classList.add('hidden');
            stopCPR();
            
            const instruction = 'Analizando el ritmo cardíaco... NO TOQUE AL PACIENTE.';
            updateInstruction(instruction, 'warning');
            speak(instruction);

            setTimeout(decideShock, 4500);
        }

        function decideShock() {
            if (state !== 'ANALYZING') return;
            
            const shockAdvised = Math.random() > 0.3; 

            if (shockAdvised) {
                state = 'SHOCK_ADVISED';
                const instruction = 'Se recomienda una descarga. Apártese del paciente.';
                updateInstruction(instruction, 'danger');
                speak(instruction);
                setTimeout(chargeShock, 3000);
            } else {
                state = 'NO_SHOCK_ADVISED';
                const instruction = 'No se recomienda una descarga.';
                updateInstruction(instruction, 'info');
                speak(instruction);
                setTimeout(startCPR, 3000);
            }
        }

        function chargeShock() {
            if (state !== 'SHOCK_ADVISED') return;
            const instruction = 'Cargando... Manténgase apartado.';
            updateInstruction(instruction, 'danger');
            speak(instruction);

            playChargingSound(3);
            
            setTimeout(() => {
                if (state !== 'SHOCK_ADVISED') return;
                
                state = 'SHOCK_READY';
                const instructionReady = '¡APÁRTESE! Presione el botón de descarga parpadeante.';
                updateInstruction(instructionReady, 'danger');
                speak(instructionReady);
                
                btnShock.disabled = false;
                btnShock.classList.remove('opacity-50', 'cursor-not-allowed');
                btnShock.classList.add('flashing', 'hover:bg-orange-600');
            }, 3500);
        }

        function deliverShock() {
            if (state !== 'SHOCK_READY') return;
            state = 'SHOCK_DELIVERED';

            btnShock.disabled = true;
            btnShock.classList.remove('flashing', 'hover:bg-orange-600');
            btnShock.classList.add('opacity-50', 'cursor-not-allowed');

            playBeep(783, 0.5, 'sine'); // G5

            const instruction = 'Descarga administrada. Inicie RCP.';
            updateInstruction(instruction, 'info');
            speak(instruction);
            
            document.body.classList.add('bg-yellow-300');
            setTimeout(() => {
                document.body.classList.remove('bg-yellow-300');
            }, 200);

            setTimeout(startCPR, 3000);
        }

        /**
         * Lógica de RCP (15:2 o 30:2)
         */
        function startCPR() {
            if (state !== 'NO_SHOCK_ADVISED' && state !== 'SHOCK_DELIVERED') return;
            state = 'CPR';
            
            cprArea.classList.remove('hidden');
            
            // --- LÓGICA DE MODO ---
            const compressionText = (protocolMode === 'ADULT') ? '30 Compresiones' : '15 Compresiones';
            
            cprSecondsLeft = 120;
            cprPhase = 'COMPRESSIONS';
            compressionCount = 1;
            ventilationCount = 1;
            cprTimerDisplay.textContent = '2:00';
            cprPhaseText.textContent = `Inicie ${compressionText}`;

            speak(`Inicie ${compressionText}`);

            cprOverallTimer = setTimeout(stopCPRAndAnalyze, 120000);

            cprVisualTimer = setInterval(() => {
                // --- CORRECCIÓN ---
                // Se añade un bloqueo para asegurar que el timer no muestre números
                // negativos si hay un pequeño retraso en la limpieza de los intervalos.
                if (cprSecondsLeft <= 0) {
                    clearInterval(cprVisualTimer); // Detiene este temporizador
                    return;
                }
                // --- FIN CORRECCIÓN ---

                cprSecondsLeft--;
                let minutes = Math.floor(cprSecondsLeft / 60);
                let remainingSeconds = cprSecondsLeft % 60;
                cprTimerDisplay.textContent = `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
            }, 1000);

            runCprCycle();
        }

        /**
         * Reproduce un solo bip del metrónomo
         */
        function playMetronomeBeep() {
            if (!audioCtx) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.type = 'square'; 
            oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.1);
        }

        /**
         * Motor del ciclo RCP (se auto-invoca con setTimeout)
         */
        function runCprCycle() {
            if (state !== 'CPR') return;

            // --- LÓGICA DE MODO ---
            const compressionLimit = (protocolMode === 'ADULT') ? 30 : 15;

            if (cprPhase === 'COMPRESSIONS') {
                metronome.textContent = compressionCount;
                metronome.classList.add('pulsing');
                playMetronomeBeep();
                setTimeout(() => metronome.classList.remove('pulsing'), 100);

                compressionCount++;

                if (compressionCount > compressionLimit) {
                    cprPhase = 'VENTILATIONS';
                    ventilationCount = 1;
                    cprPhaseText.textContent = 'Dé 2 Ventilaciones';
                    speak('Dé 2 ventilaciones');
                    metronome.textContent = 'V-1';
                    metronome.classList.remove('pulsing');
                    cprCycleTimer = setTimeout(runCprCycle, 4000); 
                } else {
                    cprCycleTimer = setTimeout(runCprCycle, 600);
                }
            } else if (cprPhase === 'VENTILATIONS') {
                if (ventilationCount === 1) {
                    ventilationCount = 2;
                    metronome.textContent = 'V-2';
                    cprCycleTimer = setTimeout(runCprCycle, 4000); 
                } else {
                    // --- LÓGICA DE MODO ---
                    const compressionText = (protocolMode === 'ADULT') ? '30 Compresiones' : '15 Compresiones';
                    
                    cprPhase = 'COMPRESSIONS';
                    compressionCount = 1;
                    cprPhaseText.textContent = `Inicie ${compressionText}`;
                    speak(`Inicie ${compressionText}`);
                    cprCycleTimer = setTimeout(runCprCycle, 600);
                }
            }
        }

        /**
         * Detiene todos los temporizadores de RCP
         */
        function stopCPR() {
            clearInterval(cprVisualTimer);
            clearTimeout(cprOverallTimer);
            clearTimeout(cprCycleTimer);
            
            metronome.classList.remove('pulsing');
            cprArea.classList.add('hidden');
        }

        /**
         * Función llamada después de 2 minutos de RCP
         */
        function stopCPRAndAnalyze() {
            if (state !== 'CPR') return;
            
            state = 'CPR_DONE';
            const instructionStop = 'Detenga la RCP.';
            updateInstruction(instructionStop, 'warning');
            speak(instructionStop);
            stopCPR();
            setTimeout(startAnalysis, 2000);
        }

        /**
         * Reinicia el simulador volviendo a la pantalla de selección.
         */
        function resetSimulator() {
            // --- CORRECCIÓN ---
            // 1. Detener todos los temporizadores de RCP (visual, ciclo, general)
            stopCPR();

            // 2. Detener cualquier voz que esté hablando
            speech.cancel();
            
            // 3. Cerrar el contexto de audio si se ha inicializado
            if (audioCtx) {
                // Usamos .catch() por si ya estaba cerrado, para evitar un error en consola
                audioCtx.close().catch(console.error); 
                audioCtx = null; // Liberar la variable
            }
            
            // 4. Recargar la página para un reinicio 100% limpio
            location.reload();
        }

        // --- Helper de Instrucciones ---
        function updateInstruction(text, type) {
            instructionText.textContent = text;
            instructionText.classList.remove('text-yellow-300', 'text-green-300', 'text-red-300');
            instructionText.classList.add('text-white'); 
        }

        // --- Asignación de Eventos ---
        btnSelectAdult.addEventListener('click', () => initSimulator('ADULT'));
        btnSelectPediatric.addEventListener('click', () => initSimulator('PEDIATRIC'));

        btnPower.addEventListener('click', powerOn);
        btnApplyPads.addEventListener('click', applyPads);
        btnShock.addEventListener('click', deliverShock);
        btnReset.addEventListener('click', resetSimulator);

        // --- Cargar voces al iniciar ---
        updateVoiceList();
        if (speech.onvoiceschanged !== undefined) {
            speech.onvoiceschanged = updateVoiceList;
        }

    </script>
</body>
</html>
